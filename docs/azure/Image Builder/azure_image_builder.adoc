AZURE IMAGE BUILDER
===================
// Metadata:
:description: Como crear imagenes propias para el Stratio cloud-provisioner en Azure.
:keywords: azure, aks, image, builder, stratio, cloud-provisioner
// Settings:
// Deshabilitar el modo de compatibilidad
:compat-mode!:
// Deshabilitar la fecha de actualizaci√≥n
:last-update-label!:
// Habilitamos el uso de iconos
:icons: font
// Sobreescritura de la fuente de los iconos
:icon-set: fa
// Definimos el directorio de imagenes
:imagesdir: ../images
// // Refs:
:url-project: https://asciidoctor.org
:url-docs: {url-project}/docs
:url-issues:  https://github.com/asciidoctor/asciidoctor
:img-ci: https://github.com/asciidoctor/asciidoctor/workflows/CI/badge.svg
:url-antora: https://docs.antora.org/antora/latest/asciidoc/asciidoc/
// Tabla de contenidos
:toc: left
:toclevels: 6
:toc-title: üõ†Ô∏è Azure Image Builder
:source-highlighter: rouge
:rouge-style: monokai

== https://image-builder.sigs.k8s.io/capi/capi.html[Introducci√≥n]

Image Builder se puede utilizar para crear im√°genes destinadas a su uso con proveedores de CAPI de Kubernetes. Cada proveedor tiene su propio formato de im√°genes con el que puede trabajar. Por ejemplo, las instancias de AWS utilizan AMI.

== Prerequisitos

=== Prerequisitos Globales
Packer y Ansible se utilizan para construir estas im√°genes. Esta herramienta se ha bifurcado y ampliado del proyecto Wardroom.

Versi√≥n del empaquetador >= 1.6.0
Complemento de Goss para la versi√≥n de Packer >= 1.2.0
Versi√≥n de Ansible >= 2.10.0
Si los archivos binarios necesarios no est√°n presentes, se pueden instalar en images/capi/.bin con el comando make deps. Este directorio deber√° agregarse a su $PATH.

== https://image-builder.sigs.k8s.io/capi/capi.html#customization[Configuraciones de la imagen]

=== https://github.com/kubernetes-sigs/image-builder/tree/1510769a271725cda3d46907182a2843ef5c1c8b/images/capi/packer/gce[Im√°genes Disponibles]
Para modificar la configuraci√≥n de la imagen, puede editar el archivo images/capi/packer/config/ami-<OS>.json. Los par√°metros de configuraci√≥n se pueden encontrar en la documentaci√≥n de Packer (Haz click en la secci√≥n de este documento a tal efecto).

[TIP]
====
üìÇ https://kubernetes.io/releases/[Version de Kubernetes]::
[%autowidth]
Hay que editar el fichero _images/capi/packer/config/kubernetes.json_
|===
| *crictl_version* | 1.26.1 | Version de las critools
| *kubernetes_deb_version* | 1.26.8-00 | Version de kubernetes para Debian
| *kubernetes_rpm_version* | 1.26.8-0 | Versi√≥n de kubernetes para RPM
| *kubernetes_semver* | 1.26.8 | Versi√≥n sem√°ntica de Kubernetes que se instalar√° en la imagen
| *kubernetes_series* | 1.26 | Versi√≥n de la serie de Kubernetes que se instalar√° en la imagen
|===

üìÇ https://github.com/kubernetes-sigs/cri-tools/tags[Version de las critools]::
[%autowidth]
|===
| *crictl version* | *kubernetes version*
| 1.26.1 | 1.24, 1.25, 1.26
| 1.27.1 | 1.27
| 1.28.0 | 1.28
|===

== Construcci√≥n de la imagen

. Exportar los datos de la subscripci√≥n de Azure en la que vamos a trabajar
[source,shell]
export AZURE_SUBSCRIPTION_ID="<subscriptionID>"
export AZURE_TENANT_ID="<tenantID>"
export AZURE_LOCATION="<region>"

. Exportar el resource group que se usar√° para almacenar las im√°genes creadas
[source,shell]
export RESOURCE_GROUP_NAME="<resourceGroup>"

. Exportar las credenciales de la cuenta de servicio creadas en el paso anterior
[source,shell]
export AZURE_CLIENT_ID="<clientID>"
export AZURE_CLIENT_SECRET="<clientSecret>"

. Clonar el repositorio de image-builder si no lo tien√≠as previamente
[source,shell]
git clone https://github.com/kubernetes-sigs/image-builder.git
cd image-builder/images/capi/

. Instalar las dependencias necesarias para crear la imagen
[source,shell]
make deps-azure

. Consultar las im√°genes que podemos construir
[source,shell]
make help | grep build-azure-sig

. Generar la im√°gen deseada
[source,shell]
make build-azure-sig-ubuntu-2204

== Debug

Podemos debugear el proceso de creaci√≥n de la imagen con la variable de entorno PACKER_LOG
[source,shell]
export PACKER_LOG=1
