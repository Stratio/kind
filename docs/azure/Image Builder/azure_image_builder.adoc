AZURE IMAGE BUILDER
===================
// Metadata:
:description: Como crear imagenes propias para el Stratio cloud-provisioner en Azure.
:keywords: azure, aks, image, builder, stratio, cloud-provisioner
// Settings:
// Deshabilitar el modo de compatibilidad
:compat-mode!:
// Deshabilitar la fecha de actualizaci√≥n
:last-update-label!:
// Habilitamos el uso de iconos
:icons: font
// Sobreescritura de la fuente de los iconos
:icon-set: fa
// Definimos el directorio de imagenes
:imagesdir: ../images
// // Refs:
:url-project: https://asciidoctor.org
:url-docs: {url-project}/docs
:url-issues:  https://github.com/asciidoctor/asciidoctor
:img-ci: https://github.com/asciidoctor/asciidoctor/workflows/CI/badge.svg
:url-antora: https://docs.antora.org/antora/latest/asciidoc/asciidoc/
// Tabla de contenidos
:toc: left
:toclevels: 6
:toc-title: üõ†Ô∏è Azure Image Builder
:source-highlighter: rouge
:rouge-style: monokai

== Introducci√≥n

Image Builder se puede utilizar para crear im√°genes destinadas a su uso con proveedores de CAPI de Kubernetes. Cada proveedor tiene su propio formato de im√°genes con el que puede trabajar. Por ejemplo, las instancias de AWS utilizan AMI.

üîó https://image-builder.sigs.k8s.io/capi/capi.html[Kubernetes Image Builder]

== Prerequisitos

=== Prerequisitos Globales
Packer y Ansible se utilizan para construir estas im√°genes. Esta herramienta se ha bifurcado y ampliado del proyecto Wardroom.

Versi√≥n del empaquetador >= 1.6.0
Complemento de Goss para la versi√≥n de Packer >= 1.2.0
Versi√≥n de Ansible >= 2.10.0
Si los archivos binarios necesarios no est√°n presentes, se pueden instalar en images/capi/.bin con el comando make deps. Este directorio deber√° agregarse a su $PATH.

== Im√°genes Disponibles

üîó https://portal.azure.com/#@asistemasstratio.onmicrosoft.com/resource/subscriptions/6e2a38cd-ef16-47b3-a75e-5a4960cedf65/resourceGroups/capz/overview[VM image definition]


== Configuraciones de la imagen

Para modificar la configuraci√≥n de la imagen, puede editar el archivo _images/capi/packer/azure/ubuntu-<osversion>.json_.

Los par√°metros de configuraci√≥n se pueden encontrar en la documentaci√≥n de Packer.

üîó https://image-builder.sigs.k8s.io/capi/capi.html#customization[Image build customization]


[TIP]
====
üìÇ Version de Kubernetes
[%autowidth]

Hay que editar el fichero _images/capi/packer/config/kubernetes.json_
[%hardbreaks]
üîó https://kubernetes.io/releases/[Kubernetes releases]
|===
| *crictl_version* | 1.26.1 | Version de las critools
| *kubernetes_deb_version* | 1.26.8-00 | Version de kubernetes para Debian
| *kubernetes_rpm_version* | 1.26.8-0 | Versi√≥n de kubernetes para RPM
| *kubernetes_semver* | 1.26.8 | Versi√≥n sem√°ntica de Kubernetes que se instalar√° en la imagen
| *kubernetes_series* | 1.26 | Versi√≥n de la serie de Kubernetes que se instalar√° en la imagen
|===

üìÇ Version de las critools
[%autowidth]
La versi√≥n de las critools tiene que ir pareja con la versi√≥n de kubernetes que estemos usando.
[%hardbreaks]
üîó https://github.com/kubernetes-sigs/cri-tools/tags[Critools releases]

|===
| *crictl version* | *kubernetes version*
| 1.26.1 | 1.24, 1.25, 1.26
| 1.27.1 | 1.27
| 1.28.0 | 1.28
|===

üìÇ Par√°metros del kernel
[%autowidth]
Hay que editar el fichero _ansible/roles/node/tasks/main.yml_ y dentro editar la tarea con el nombre '_Set and persist kernel params_' para a√±adir vm.max_map_count con valor 262144

[source,yaml]

- name: Set and persist kernel params
  sysctl:
    name: "{{ item.param }}"
    value: "{{ item.val }}"
    state: present
    sysctl_set: yes
    sysctl_file: "{{ sysctl_conf_file }}"
    reload: yes
  loop:
    - { param: net.bridge.bridge-nf-call-iptables, val: 1 }
    - { param: net.bridge.bridge-nf-call-ip6tables, val: 1 }
    - { param: net.ipv4.ip_forward, val: 1 }
    - { param: net.ipv6.conf.all.forwarding, val: 1 }
    - { param: net.ipv6.conf.all.disable_ipv6, val: 0 }
    - { param: net.ipv4.tcp_congestion_control, val: bbr }
    - { param: vm.overcommit_memory, val: 1 }
    - { param: kernel.panic, val: 10 }
    - { param: kernel.panic_on_oops, val: 1 }
    - { param: fs.inotify.max_user_instances, val: 8192 }
    - { param: fs.inotify.max_user_watches, val: 524288 }
    - { param: vm.max_map_count, val: 262144 }

====

== Construcci√≥n de la imagen

. Exportar los datos de la subscripci√≥n de Azure en la que vamos a trabajar
[source,console]
export AZURE_SUBSCRIPTION_ID="<subscriptionID>"
export AZURE_TENANT_ID="<tenantID>"
export AZURE_LOCATION="<region>"

. Exportar el resource group que se usar√° para almacenar las im√°genes creadas
[source,console]
export RESOURCE_GROUP_NAME="<resourceGroup>"

. Exportar las credenciales de la cuenta de servicio creadas en el paso anterior
[source,console]
export AZURE_CLIENT_ID="<clientID>"
export AZURE_CLIENT_SECRET="<clientSecret>"

. Preparar el repositorio de image-builder

.. Clonar el repositorio de image-builder si no lo tien√≠as previamente
[source,console]
git clone https://github.com/kubernetes-sigs/image-builder.git
cd image-builder/images/capi/

.. Actualizar el repositorio de image-builder si ya lo ten√≠as previamente
[source,console]
cd image-builder
git pull
cd images/capi/

. Instalar las dependencias necesarias para crear la imagen
[source,console]
make deps-azure

. Consultar las im√°genes que podemos construir
[source,console]
make help | grep build-azure-sig

. Generar la im√°gen deseada
[source,console]
make build-azure-sig-ubuntu-2204

== Debug

Podemos debugear el proceso de creaci√≥n de la imagen con la variable de entorno PACKER_LOG
[source,shell]
export PACKER_LOG=1
