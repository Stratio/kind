= Constructor de imágenes de AWS

Esta sección explica cómo crear imágenes propias para _Stratio Cloud Provisioner_ en https://image-builder.sigs.k8s.io/capi/providers/aws[AWS] ^[English]^.

== Prerrequisitos

=== Globales

Se utilizan Packer y Ansible para construir las imágenes.

* Versión del empaquetador (Packer) ≥ 1.9.4
* Complemento de Goss para Packer ≥ 3.1.4
* Versión de Ansible ≥ 2.15.4

Si los archivos binarios necesarios no están presentes, se pueden instalar en _~/.local/bin_ con el comando `make deps-ami`. Este directorio deberá agregarse a su _$PATH_.

=== De AWS

Es necesario tener:

* Una cuenta de AWS con un https://image-builder.sigs.k8s.io/capi/providers/aws.html#configuration:~:text=Required%20Permissions%20to%20Build%20the%20AWS%20AMIs[usuario IAM con los permisos mínimos necesarios para crear una imagen] ^[English]^.
* https://docs.aws.amazon.com/es_es/cli/latest/userguide/cli-chap-configure.html[AWS CLI instalado y configurado].
* VPC por defecto para el usuario de AWS.
* Par de claves para la conexión SSH a la instancia.
* Grupo de seguridad permitiendo el tráfico por el puerto 22 para el protocolo TCP.

==== Errores frecuentes

* *VPCIdNotSpecified: no hay VPC por defecto para este usuario*
+
Para solucionarlo, edita el fichero _images/capi/packer/ami/packer.json_ y modifica el valor de la variable `vpc_id` con el ID de la VPC por defecto de tu cuenta de AWS. Para conseguir dicho valor debes navegar a la sección 'VPC' de la consola de AWS y copiar el _VPC ID_ de la pestaña 'Details'.
+
image::vpc-id.png[]

* *"`subnet_id` or `subnet_filter` must be provided for non-default VPCs"*
+
Para solucionarlo, edita el fichero _images/capi/packer/ami/packer.json_ y modifica el valor de la variable `subnet_id` por el ID de una _subnet_ de la VPC especificada en la variable `vpc_id`.

* *"Timeout waiting for SSH"*
+
Sigue estos pasos para solucionarlo:
+
. Edita el fichero _images/capi/packer/ami/packer.json_ y modifica el valor de la variable `ssh_keypair_name` por el nombre de la clave SSH.
+
[source,json]
----
"ssh_keypair_name": "my-ssh-keypair"
----
+
. Modifica el valor de la variable `ssh_private_key_file` por la ruta al fichero de la clave privada SSH.
+
[source,json]
----
"ssh_private_key_file": "/home/user/.ssh/my-ssh-keypair.pem"
----
+
. La máquina virtual debe tener una IP pública para poder conectarse a ella. Si no tiene, puedes crearla para la instancia editando el fichero _images/capi/packer/ami/packer.json_ y modificando/añadiendo el valor de la variable `associate_public_ip_address` a _true_ en la sección 'builders'.
+
[source,json]
----
"associate_public_ip_address": "true"
----
+
. Crea/asigna un grupo de seguridad (con permisos al puerto 22) a la instancia creada (en la misma red que esta) y modifica/añade el valor de la variable `security_group_id` con el ID del grupo de seguridad creado/asignado en el fichero _images/capi/packer/ami/packer.json_ en la sección 'builders'.
+
[source,json]
----
"security_group_id": "sg-1234567890"
----
+
image::security-group.png[]
+
. Añade la variable `ssh_interface` = "public_ip" en la sección 'builders' del fichero _images/capi/packer/ami/packer.json_ para que se conecte a la instancia por la IP privada.
+
[source,json]
----
"ssh_interface": "public_ip"
----
+
. Crea un _internet gateway_ y una _route table_ (o usa la de por defecto) para la VPC de tu cuenta de AWS y asócialos.
+
image::internet-gatway.png[]

== Configuración de la imagen

Para construir una imagen de AWS, es necesario crear un fichero de configuración para Packer. Este fichero contiene la configuración de la imagen, como el tipo de instancia, la región, la versión de Kubernetes, etc.

[source,json]
{
    "crictl_version": "1.29.0",
    "kubernetes_series": "v1.26",
    "kubernetes_semver": "v1.26.14",
    "kubernetes_deb_version": "1.26.14-1.1",
    "kubernetes_rpm_version": "1.26.14",
    "builder_instance_type": "t3.medium",
    "node_custom_roles_post": "stratio",
    "ansible_extra_vars": "pinned_debs=\"cloud-init=23.1.2-0ubuntu0~22.04.1\"",
    "associate_public_ip_address": "true",
    "ssh_interface": "public_ip",
    "aws_region": "eu-west-1",
    "ami_regions": "eu-west-1",
    "aws_security_group_ids": "sg-0bae9383628c59c25",
    "ssh_keypair_name": "stratio",
    "ssh_private_key_file": "/home/stratio/.ssh/id_ed25519"
}

Explicación de los parámetros:

[%autowidth]
|===
| *crictl_version* | 1.29.0 | Versión de las https://github.com/kubernetes-sigs/cri-tools/tags[cri-tools]
| *kubernetes_series* | v1.26 | Versión de Kubernetes que se instalará en la imagen.
| *kubernetes_semver* | v1.26.14 | Versión semántica de Kubernetes que se instalará en la imagen.
| *kubernetes_deb_version* | 1.26.14-1.1 | Versión de Kubernetes para Debian.
| *kubernetes_rpm_version* | 1.26.14 | Versión de Kubernetes para RPM.
| *builder_instance_type* | t3.medium | Tipo de instancia para la construcción de la imagen.
| *node_custom_roles_post* | stratio | Rol de ansible personalizado para el nodo.
| *ansible_extra_vars* | pinned_debs="cloud-init=23.1.2-0ubuntu0~22.04.1" | Parche de cloud-init para las AMIs de Ubuntu 22.04 en AWs.
| *associate_public_ip_address* | true | Asigna una IP pública a la instancia.
| *ssh_interface* | public_ip | Interfaz de red por la que se conectará a la instancia.
| *aws_region* | eu-west-1 | Región de AWS donde se creará la instancia para la construcción de la imagen.
| *ami_regions* | eu-west-1 | Regiones de AWS donde se disponibilizará la imagen.
| *aws_security_group_ids* | sg-0bae9383628c59c25 | ID del grupo de seguridad de la instancia.
| *ssh_keypair_name* | stratio | Nombre de la clave SSH.
| *ssh_private_key_file* | /home/stratio/.ssh/id_ed25519 | Ruta al fichero de la clave privada SSH.
|===


Para modificar la https://image-builder.sigs.k8s.io/capi/capi.html#customization[configuración de la imagen] ^[English]^ puedes editar el archivo _images/capi/packer/config/ami-<OS>.json_. Los parámetros de configuración se pueden encontrar en la https://github.com/kubernetes-sigs/image-builder/tree/1510769a271725cda3d46907182a2843ef5c1c8b/images/capi/packer/ami[documentación de Packer] ^[English]^.

== Construcción de la imagen

. Clona el repositorio _image-builder_ si no lo tenías previamente.
+
[source,console]
----
git clone https://github.com/kubernetes-sigs/image-builder.git
cd image-builder
----
+
O actualízalo si ya lo tenías.
+
[source,console]
----
cd image-builder
git pull
----

. Posiciónate en la ruta _images/capi_ dentro del repositorio.
+
[source,console]
----
cd images/capi
----

. Instala las dependencias necesarias para crear la imagen.
+
[source,console]
----
make deps-ami
----
+
image::desp-ami.png[]

. Consulta las imágenes que se pueden construir.
+
[source,console]
----
make help | grep build-ami
----

. Genera la imagen deseada, pasándole el json de configuración que preparamos anteriormente como variable de entorno `PACKER_VAR_FILES` y el objetivo de la imagen que queremos construir. Por ejemplo, para construir una imagen de Ubuntu 22.04, ejecuta:
+
[source,console]
----
PACKER_VAR_FILES=aws.json make build-ami-ubuntu-2204
----
+
image::build-ami-ubuntu-2204-part1.png[]
+
image::build-ami-ubuntu-2204-part2.png[]
+
image::amis.png[]

== Depuración

El proceso de creación de la imagen se puede depurar con la variable de entorno `PACKER_LOG`.

[source,console]
----
export PACKER_LOG=1
----
