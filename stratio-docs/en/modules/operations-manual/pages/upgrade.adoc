= Version upgrade script

== Description

The `upgrade-provisioner.py` script automates Kubernetes cluster upgrades in the following environments:

- *EKS* on AWS.
- *Azure VMs*.

It allows you to upgrade the Kubernetes cluster version from the version installed by `cloud-provisioner 0.5.X` to that provided by `cloud-provisioner 0.6.X`. To ensure a reproducible runtime environment, the Docker image `stratio-cloud-provisioner-upgrade-image` has been created, which includes the upgrade script and all necessary dependencies.

== Requirements

=== General

* `kubeconfig` file with access to the cluster.
* `secrets.yml` file used during cluster creation.
* Docker tool, required to run the container.

== Running the script

=== Building the container

Run the Docker container with the version upgrade image, mounting the required files:

[source,bash]
----
docker run --rm -it -v <secrets.yml path>:/upgrade/secrets.yml -v <kubeconfig path>:/upgrade/.kube/config stratio-cloud-provisioner-upgrade-image:0.6.X
----

=== Using the version upgrade script

==== Syntax

[source,bash]
----
python3 upgrade-provisioner.py [OPTIONS]
----

Key options:

|===
| Flag | Description | Default Value | Mandatory

| `-p`, `--vault-password`
| Specify the Vault password needed to decrypt secrets.
|
| Yes

| `-y`, `--yes`
| Skip task confirmations (automatic mode).
| False
| No

| `-k`, `--kubeconfig`
| Specify the Kubectl configuration file to use.
| ~/.kube/config
| No

| `-s`, `--secrets`
| Encrypted secrets file.
| secrets.yml
| No

| `--enable-lb-controller`
| Enable the load balancer controller in EKS (disabled by default).
| False
| No

| `--disable-backup`
| Disable backup before upgrading (enabled by default).
| False
| No

| `--disable-prepare-capsule`
| Disable environment preparation for the upgrade process.
| False
| No

| `--upgrade-cloud-provisioner-only`
| Prepare the upgrade process for the cloud-provisioner upgrade only. This is only supported in EKS environments.
| False
| No

| `--skip-k8s-intermediate-version`
| Skip updating the workers to the intermediate Kubernetes version. This is only supported in EKS environments.
| False
| No
|===

====

== Required structure

Ensure that the working directory includes the following:

* `upgrade-provisioner.py`: main script.
* `templates/`: Jinja2 templates.
* `files/`: additional files (configurations, Helm, etc.).
* `requirements.txt`: required dependencies.
* `secrets.yml`: cluster credentials.  
* `.kube/`: directory containing the `kubeconfig` file.
